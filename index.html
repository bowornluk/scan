<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อนักเรียนอัจฉริยะ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
       body { font-family: 'Inter', 'Kanit', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: rgba(0,0,0,0.05); }
        .dark .sortable-header:hover { background-color: rgba(255,255,255,0.05); }
        .summary-row:hover { background-color: #f3f4f6; }
        .dark .summary-row:hover { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-6">
        <header class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
             <div class="flex items-center space-x-3">
                <i data-lucide="scan-face" class="text-blue-600 w-8 h-8"></i>
                <h1 class="text-xl md:text-2xl font-bold text-gray-700 dark:text-gray-200">ระบบเช็คชื่อนักเรียนอัจฉริยะ</h1>
            </div>
            <div class="flex items-center gap-2">
                <nav class="flex items-center flex-wrap justify-center space-x-1 md:space-x-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-3 py-1.5 text-sm font-medium rounded-md">Dashboard</button>
                    <button onclick="switchTab('attendance')" id="tab-attendance" class="px-3 py-1.5 text-sm font-medium rounded-md">เช็คชื่อ</button>
                    <button onclick="switchTab('manage')" id="tab-manage" class="px-3 py-1.5 text-sm font-medium rounded-md">จัดการข้อมูล</button>
                    <button onclick="switchTab('report')" id="tab-report" class="px-3 py-1.5 text-sm font-medium rounded-md">รายงาน</button>
                    <button onclick="switchTab('summary')" id="tab-summary" class="px-3 py-1.5 text-sm font-medium rounded-md">สรุปผล</button>
                </nav>
                <button onclick="toggleTheme()" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-sm p-2.5">
                    <i data-lucide="sun" id="theme-icon-sun" class="hidden w-5 h-5"></i>
                    <i data-lucide="moon" id="theme-icon-moon" class="hidden w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main id="main-content">
            <div id="content-dashboard" class="hidden space-y-6">...</div>
            <div id="content-attendance" class="hidden space-y-6">...</div>
            <div id="content-manage" class="hidden">...</div>
            <div id="content-report" class="hidden">...</div>

            <div id="content-summary" class="hidden">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md space-y-4">
                    <h2 class="text-xl font-bold">สรุปการมาเรียนและคะแนน</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="summary-class-filter" class="block font-medium mb-1 text-sm">เลือกชั้นเรียน:</label>
                            <select id="summary-class-filter" class="w-full border rounded-lg p-2 bg-transparent dark:text-gray-200 dark:border-gray-600">
                                <option value="all">ทุกชั้นเรียน</option>
                            </select>
                        </div>
                        <div>
                            <label for="summary-period-filter" class="block font-medium mb-1 text-sm">เลือกช่วงเวลา:</label>
                            <select id="summary-period-filter" class="w-full border rounded-lg p-2 bg-transparent dark:text-gray-200 dark:border-gray-600">
                                <option value="month">รายเดือน</option>
                                </select>
                        </div>
                        <div>
                            <label for="summary-date-filter" class="block font-medium mb-1 text-sm">เลือกเดือน/เริ่มต้นภาคเรียน:</label>
                            <input type="date" id="summary-date-filter" class="w-full border rounded-lg p-2 bg-transparent dark:text-gray-200 dark:border-gray-600">
                        </div>
                        <button onclick="generateSummaryReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 h-10 flex items-center justify-center gap-2">
                            <i data-lucide="bar-chart-3"></i><span>แสดงสรุปผล</span>
                        </button>
                    </div>
                    
                    <div id="summary-results-container" class="mt-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">ภาพรวมรายวิชา</h3>
                            <button onclick="exportSummaryToExcel()" id="export-excel-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2 hidden">
                                <i data-lucide="file-down"></i><span>ส่งออกเป็น Excel</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[800px]">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="p-3 text-left">ชั้น</th>
                                        <th class="p-3 text-left">รายวิชา</th>
                                        <th class="p-3 text-center">นักเรียนทั้งหมด</th>
                                        <th class="p-3 text-center">มา</th>
                                        <th class="p-3 text-center">ขาด</th>
                                        <th class="p-3 text-center">ลา</th>
                                        <th class="p-3 text-center">% การเข้าเรียน</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="student-detail-container" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold mb-2" id="student-detail-title"></h3>
                        <div class="overflow-x-auto max-h-[60vh] custom-scrollbar">
                             <table class="w-full min-w-[600px]">
                                <thead class="bg-gray-50 dark:bg-gray-700/50 sticky top-0">
                                    <tr>
                                        <th class="p-3 text-left">รหัสนักเรียน</th>
                                        <th class="p-3 text-left">ชื่อ-สกุล</th>
                                        <th class="p-3 text-center">มา</th>
                                        <th class="p-3 text-center">ขาด</th>
                                        <th class="p-3 text-center">ลา</th>
                                        <th class="p-3 text-center">คะแนนเข้าเรียน</th>
                                    </tr>
                                </thead>
                                <tbody id="student-detail-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                        <div class="text-right mt-4">
                            <button onclick="saveScores()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                <i data-lucide="save"></i> บันทึกคะแนน
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="student-modal" class="hidden">...</div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        // ... (all existing global variables)
        let summaryReportData = {}; // [NEW] To store data for the summary page

        // --- INITIALIZATION ---
        window.onload = async () => {
            // ... (existing onload code)
            document.getElementById('summary-date-filter').valueAsDate = new Date();
        };
        
        // --- UI & NAVIGATION ---
        async function switchTab(tabName) {
            stopScanning(false);
            // [MODIFIED] Add 'summary' to the list
            ['dashboard', 'attendance', 'manage', 'report', 'summary'].forEach(name => {
                const contentEl = document.getElementById(`content-${name}`);
                const tabEl = document.getElementById(`tab-${name}`);
                if (contentEl) contentEl.classList.add('hidden');
                if (tabEl) {
                    tabEl.classList.remove('bg-blue-600', 'text-white');
                    tabEl.classList.add('text-gray-600', 'dark:text-gray-300');
                }
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('bg-blue-600', 'text-white');
            activeTab.classList.remove('text-gray-600', 'dark:text-gray-300');
            
            if (tabName === 'dashboard') { /* ... */ }
            // ... (other tab conditions)
            else if (tabName === 'summary') {
                await loadStudentData(); // Ensure students are loaded
                loadDataForSummaryFilters();
            }
        }
        
        // --- ATTENDANCE PROCESS ---
        // ... (all existing attendance functions: startScanning, startManualCheck, etc.)

        // --- SUMMARY REPORT & SCORING ---
        function loadDataForSummaryFilters() {
            const classFilter = document.getElementById('summary-class-filter');
            if (classFilter.options.length > 1) return; // Prevent re-populating
            const classes = [...new Set(students.map(s => s.class))].filter(Boolean);
            classes.sort().forEach(className => {
                classFilter.add(new Option(className, className));
            });
        }

        async function generateSummaryReport() {
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8"><div class="loader w-8 h-8 rounded-full border-4 border-gray-200 mx-auto"></div><p>กำลังประมวลผลสรุปผล...</p></td></tr>`;
            document.getElementById('student-detail-container').classList.add('hidden');
            document.getElementById('export-excel-btn').classList.add('hidden');

            const filters = {
                classFilter: document.getElementById('summary-class-filter').value,
                period: document.getElementById('summary-period-filter').value,
                date: document.getElementById('summary-date-filter').value,
            };

            try {
                const response = await apiCall({ action: 'getAttendanceSummaryReport', data: filters });
                if (response.success) {
                    summaryReportData = response.data; // Store all data globally
                    tableBody.innerHTML = '';

                    if (summaryReportData.summary.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</td></tr>`;
                        return;
                    }
                    
                    summaryReportData.summary.forEach(item => {
                        const attendancePercent = item.totalStudents > 0 ? ((item.present / item.totalStudents) * 100).toFixed(2) : "0.00";
                        const row = document.createElement('tr');
                        row.className = 'summary-row cursor-pointer';
                        row.onclick = () => showStudentDetail(item.class, item.subject);
                        row.innerHTML = `
                            <td class="p-3">${item.class}</td>
                            <td class="p-3 font-medium">${item.subject}</td>
                            <td class="p-3 text-center">${item.totalStudents}</td>
                            <td class="p-3 text-center text-green-600">${item.present}</td>
                            <td class="p-3 text-center text-red-600">${item.absent}</td>
                            <td class="p-3 text-center text-yellow-600">${item.leave}</td>
                            <td class="p-3 text-center font-bold">${attendancePercent}%</td>`;
                        tableBody.appendChild(row);
                    });
                    document.getElementById('export-excel-btn').classList.remove('hidden');
                } else {
                    throw new Error(response.error);
                }
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-500">เกิดข้อผิดพลาด: ${err.message}</td></tr>`;
            }
        }

        function showStudentDetail(className, subjectName) {
            const detailContainer = document.getElementById('student-detail-container');
            const detailTableBody = document.getElementById('student-detail-table-body');
            
            document.getElementById('student-detail-title').innerText = `รายชื่อนักเรียนและคะแนน - ห้อง ${className} | วิชา: ${subjectName}`;
            detailTableBody.innerHTML = '';
            
            const studentsInClass = summaryReportData.allStudents.filter(s => s.class === className);
            const attendanceDetails = summaryReportData.details.filter(d => d.class === className && d.subject === subjectName);

            studentsInClass.forEach(student => {
                const studentRecords = attendanceDetails.filter(d => d.studentid == student.studentid);
                const presentCount = studentRecords.filter(r => r.status === 'มาเรียน').length;
                const absentCount = studentRecords.filter(r => r.status === 'ขาด').length;
                const leaveCount = studentRecords.filter(r => r.status === 'ลา').length;
                
                const scoreKey = `${student.studentid}|${subjectName}`;
                const currentScore = summaryReportData.scores[scoreKey] || '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${student.studentid}</td>
                    <td class="p-2">${student.name}</td>
                    <td class="p-2 text-center">${presentCount}</td>
                    <td class="p-2 text-center">${absentCount}</td>
                    <td class="p-2 text-center">${leaveCount}</td>
                    <td class="p-2 text-center">
                        <input type="number" class="w-20 text-center border rounded p-1 bg-white dark:bg-gray-800"
                               data-studentid="${student.studentid}"
                               data-class="${className}"
                               data-subject="${subjectName}"
                               value="${currentScore}">
                    </td>`;
                detailTableBody.appendChild(row);
            });

            detailContainer.classList.remove('hidden');
            detailContainer.scrollIntoView({ behavior: 'smooth' });
        }

        async function saveScores() {
            const scoreInputs = document.querySelectorAll('#student-detail-table-body input');
            const scoresToSave = [];
            scoreInputs.forEach(input => {
                scoresToSave.push([
                    input.dataset.studentid,
                    input.dataset.class,
                    input.dataset.subject,
                    input.value
                ]);
            });

            if (scoresToSave.length > 0) {
                try {
                    const response = await apiCall({ action: 'updateAttendanceScores', data: scoresToSave });
                    alert(response.success ? 'บันทึกคะแนนเรียบร้อย' : `เกิดข้อผิดพลาด: ${response.error}`);
                    if (response.success) {
                        // Refresh the summary to show new scores immediately
                        generateSummaryReport();
                    }
                } catch(err) {
                    alert(`เกิดข้อผิดพลาดรุนแรง: ${err.message}`);
                }
            }
        }

        function exportSummaryToExcel() {
            const table = document.getElementById('summary-table-body');
            if (!table || summaryReportData.summary.length === 0) {
                alert('ไม่มีข้อมูลสำหรับส่งออก');
                return;
            }
            
            const dataToExport = summaryReportData.summary.map(item => {
                const attendancePercent = item.totalStudents > 0 ? ((item.present / item.totalStudents) * 100).toFixed(2) : "0.00";
                return {
                    'ชั้น': item.class,
                    'รายวิชา': item.subject,
                    'นักเรียนทั้งหมด': item.totalStudents,
                    'มา': item.present,
                    'ขาด': item.absent,
                    'ลา': item.leave,
                    '% การเข้าเรียน': attendancePercent
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "สรุปการเข้าเรียน");
            
            XLSX.writeFile(workbook, `สรุปการเข้าเรียน-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // --- Other existing functions (getLocation, all modal functions, etc.) ---
        // Make sure to copy them back in if you are replacing the whole script tag.
    </script>
</body>
</html>
